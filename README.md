# Kaggle Titanic号生存者予測

------

↓参考にしたページ。

https://qiita.com/jun40vn/items/d8a1f71fae680589e05c

https://qiita.com/tani_AI_Academy/items/62151d7e151024733919

[TOC]



### 概要

kaggleで公開されている、タイタニック号の乗客の生存状況がまとめられたデータセットを分析し、乗客の情報から生存を予測するモデルを構築する。

最終的に構築したモデルのスコアは**0.813**

上位**3%**(**20,361**チームがエントリーしている中で**618**位)

※2020年8月時点

### タイタニック・データセットの各項目

生存予測に使用する特徴量は以下１２項目。訓練データには乗客データが891件、テストデータには418件存在。

- PassengerID　乗客ID
- Survived: 　　生存結果 (0: 死亡 1: 生存)
- Pclass: 　　　乗客の階級
- Name: 　　 　乗客の名前
- Sex: 　　　　 性別 女：0　男：1
- Age: 　　　　 年齢
- SibSp 　　 　 兄弟、配偶者の数。
- Parch 　　　　両親、子供の数。
- Ticket 　　　 チケット番号。
- Fare 　　　　 乗船料金。
- Cabin 　　　　部屋番号
- Embarked 　　 乗船した港

### 訓練データでの生存率

全体の生存率は38.4%となっており、特徴量の検証においては生存率が38.4%を超えるか越えないかが１つの指標になってくる。

![survive-rate](https://user-images.githubusercontent.com/68985919/93694031-0f389080-fb42-11ea-8a2b-1185c88a8244.png)

### 性別ごとの生存率

男女別では、女性の生存率が74.2%に対して、男性の生存率は18.8%であった。性別の違いが生存率に大きく関係していることとなる。

![SexRate](https://user-images.githubusercontent.com/68985919/93694038-1eb7d980-fb42-11ea-9adf-0c5f0e1be5d4.png)

### 欠損値の確認

#### 全データ（train+test)の各項目の欠損値

- 乗客ID 0 
- 生存 418 
- 階級 0 
- 名前 0 
- 性別 0 
- 年齢 263 
- 兄弟配偶者数 0 
- 両親子供数 0 
- チケット番号 0 
- 乗船料金 1 
- 部屋番号 1014 
- 乗船港 2

年齢と部屋番号の欠損値が多い。その他は乗車料金と乗船港において少数存在する。

### 年齢の欠損値の推定

年齢の欠損値に入るべき値を階級・性別・両親子供数・兄弟配偶者数を特徴量として、ランダムフォレストで推定・補完。

↓補完後の年代別生存率

![AgeGrid](https://user-images.githubusercontent.com/68985919/93694047-2a0b0500-fb42-11ea-9445-767a9767d046.png)

年齢の分布は２０〜４０才あたりが多く、死亡者がわずかに上回っている。

### 名前から特徴量設定

名前から敬称(Mr,Miss等)を抜き出し、グループ化する。

![NameRate](https://user-images.githubusercontent.com/68985919/93694049-3000e600-fb42-11ea-9ced-def6285cdd5d.png)

一般男性と役人の生存率が低く、それ以外は平均より高い。

#### 名前から苗字を抽出し、同じものは家族とみなしてカウント

家族グループを

- 16才以下、または女性のグループ
- 16才より上かつ男性のグループ

に分けて生存率を集計

```python
# 出力結果 
16才以下または女性の生存率 
1.000000 113 
0.000000 32 
0.750000 2 
0.333333 1 
0.142857 1 
0.500000 1 
==================== 
16才超えかつ男性の生存率 
0.000000 115 
1.000000 21 
0.500000 6 
0.333333 2 
0.250000 1
```



**16才以下または女性のグループ**は**113**グループが全員生存している一方で、**32**グループが全員死亡。

**16才以上かつ男性のグループ**においては、**101**グループが全員死亡している一方で、**20**グループが全員生還。

大多数のグループに対して正反対の結果のグループが一定数存在している。

- 前者の少数派（全員死亡）グループの苗字：デッドリスト
- 後者の少数派（全員生還）グループの苗字：サヴァイブリスト

としてテストデータに反映。

デッドリストグループの特徴量（性別・年齢・敬称）を典型的な死亡データに、サヴァイブリストグループの特徴量を典型的な生存データに上書きする。

### 乗船料金の欠損値補完

テストデータには、乗船料金に欠損地があるデータが一件存在。

この乗客の階級は３。乗船港はSのため、他の同じ条件の乗船料金の中央値をとって補完する。

### 両親子供数、兄弟配偶者数から特徴量設定

両親子供数と、兄弟配偶者数を合算して、家族人数という特量量に変換する。

![FamilyR](https://user-images.githubusercontent.com/68985919/93694051-368f5d80-fb42-11ea-9c4a-84cde2f259f7.png)

家族人数別の生存率を確認すると、

**2~4人家族**の生存率。**独身と5~7人家族**の生存率が

それぞれ似通っている。そして、家族人数が**８人以上は生存率０％**になる。

それぞれ同一のグループとしてまとめる。

<!--当初３つのグループに分けて機械学習にかけていたが、

後に条件を緩めて家族人数が８人以上かどうかでグループ分けするとスコアが上昇した。

おそらく、テストデータの家族人数別の生存率が、

実は訓練データとあまり相関していない可能性がある-->

### チケット番号から特徴量設定

チケット番号が同じ人が何人いるかで特徴量を設定

![TicketR](https://user-images.githubusercontent.com/68985919/93694053-4444e300-fb42-11ea-91e4-7f05c7469219.png)

生存率で分けるとチケット番号が同じ人が

- ２〜４人
- １人・５〜８人
- 11人以上

のグループに分けられる。

![TicketL](https://user-images.githubusercontent.com/68985919/93712307-0373bb00-fb90-11ea-9db4-132ec96491ff.png)

こちらについては当初３グループに分けていたが、後に条件を緩めて５人以上かどうかでグループ分けするとスコアが上昇した

### 部屋番号の欠損値補完

欠損値をunknownに変換。その上で部屋番号の頭文字でグルーピングする。

![Cabin](https://user-images.githubusercontent.com/68985919/93712217-716bb280-fb8f-11ea-9588-181f614db6fd.png)

部屋番号が不明なグループのみ生存率が飛び抜けて低いため、そのまま特徴量として使用する。

###  乗船港の欠損値処理

乗船港の欠損値２件を、一番多い「S」で補完

### データ前処理

ワンホットエンコーディングを実行し。データを訓練データとテストデータに再度分割。

### モデル構築

pycaretを使用して、モデルの選定

pycaretではXGBoostやCatboostのスコアが高かったが、実際に予測データをkaggleへ提出した際、スコアが0.8より大きく下がってしまったため過学習の可能性が高い。

いくつかのモデルを提出した結果、最終的に一番スコアが高かったのはランダムフォレストであった。

↓kaggle上での表示

![final_score01](https://user-images.githubusercontent.com/68985919/93712228-821c2880-fb8f-11ea-8355-6aa8b1acef31.png)



